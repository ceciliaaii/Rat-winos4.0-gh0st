name: Build é“¶ç‹Winos C++ Solutions

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: Build All Solutions in é“¶ç‹Winos
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup Visual Studio Developer Command Prompt
      uses: egor-tensin/vs-shell@v2

    - name: Build all .sln files (safe path + upgrade toolset)
      shell: pwsh
      run: |
        chcp 65001 > $null
        Write-Host "ğŸ” æ­£åœ¨ç¼–è¯‘æ‰€æœ‰è§£å†³æ–¹æ¡ˆ..." -ForegroundColor Cyan

        $solutionPaths = Get-ChildItem -Path "demo" -Recurse -Filter *.sln | ForEach-Object { $_.FullName }

        foreach ($sln in $solutionPaths) {
          $slnDir = Split-Path $sln
          $slnFile = Split-Path $sln -Leaf
          Push-Location $slnDir

          Write-Host "ğŸ› ï¸ æ­£åœ¨æ£€æŸ¥å¹¶å‡çº§å·¥å…·é›†: $sln" -ForegroundColor Yellow
          Get-ChildItem -Recurse -Filter *.vcxproj | ForEach-Object {
            (Get-Content $_.FullName -Raw) -replace '<PlatformToolset>v100</PlatformToolset>', '<PlatformToolset>v143</PlatformToolset>' |
              Set-Content $_.FullName -Encoding UTF8
          }

          Write-Host "ğŸ§± å¼€å§‹æ„å»º: $slnFile" -ForegroundColor Cyan
          msbuild $slnFile /p:Configuration=Release /p:Platform=x64 /m /verbosity:minimal
          $code = $LASTEXITCODE
          Pop-Location

          if ($code -ne 0) {
            Write-Host "âŒ ç¼–è¯‘å¤±è´¥: $sln" -ForegroundColor Red
            exit 1
          } else {
            Write-Host "âœ… ç¼–è¯‘æˆåŠŸ: $sln" -ForegroundColor Green
          }
        }

    - name: Upload Artifacts and Logs
      uses: actions/upload-artifact@v4
      with:
        name: Winos-build-artifacts
        path: |
          artifacts
          build.log
          build_*.log
