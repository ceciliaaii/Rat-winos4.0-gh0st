name: Build é“¶ç‹Winos C++ Solutions

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: Build All Solutions in é“¶ç‹Winos/
    runs-on: windows-latest

    env:
      # è®¾ç½® UTF-8 ç¯å¢ƒï¼Œä¿è¯ä¸­æ–‡è·¯å¾„ä¸è¾“å‡ºä¸ä¼šä¹±ç 
      LC_ALL: zh_CN.UTF-8
      LANG: zh_CN.UTF-8
      CHCP: 65001

    steps:
    # 1ï¸âƒ£ æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2ï¸âƒ£ è®¾ç½® MSBuildï¼ˆå®‰è£… Visual Studio ç¯å¢ƒï¼‰
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # 3ï¸âƒ£ å¯åŠ¨ Visual Studio Developer å‘½ä»¤è¡Œç¯å¢ƒ
    - name: Setup Visual Studio Developer Command Prompt
      uses: egor-tensin/vs-shell@v2

    # 4ï¸âƒ£ è‡ªåŠ¨æ‰«æå¹¶ç¼–è¯‘ é“¶ç‹Winos ç›®å½•ä¸‹çš„æ‰€æœ‰ .sln æ–‡ä»¶
    - name: Build all .sln files under é“¶ç‹Winos/
      shell: pwsh
      run: |
        Write-Host "ğŸ” æ­£åœ¨æ‰«æ é“¶ç‹Winos æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰ .sln æ–‡ä»¶..." -ForegroundColor Cyan
        $solutions = Get-ChildItem -Path "é“¶ç‹Winos" -Recurse -Filter *.sln -ErrorAction SilentlyContinue
        if ($solutions.Count -eq 0) {
          Write-Error "âŒ æœªåœ¨ é“¶ç‹Winos æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ä»»ä½• .sln æ–‡ä»¶ã€‚"
          exit 1
        }

        foreach ($sln in $solutions) {
          Write-Host "ğŸ› ï¸ å¼€å§‹ç¼–è¯‘è§£å†³æ–¹æ¡ˆ: $($sln.FullName)" -ForegroundColor Yellow
          # å¼ºåˆ¶ä½¿ç”¨ UTF-8 ç¼–ç ï¼Œæ”¯æŒä¸­æ–‡è·¯å¾„
          chcp 65001 > $null
          msbuild $sln.FullName /p:Configuration=Release /p:Platform=x64 /m /verbosity:minimal
          if ($LASTEXITCODE -ne 0) {
            Write-Error "âŒ ç¼–è¯‘å¤±è´¥: $($sln.FullName)"
            exit 1
          } else {
            Write-Host "âœ… ç¼–è¯‘æˆåŠŸ: $($sln.FullName)" -ForegroundColor Green
          }
        }

    # 5ï¸âƒ£ æ”¶é›†æ„å»ºäº§ç‰©
    - name: Collect build artifacts
      shell: pwsh
      run: |
        Write-Host "ğŸ“¦ æ­£åœ¨æ”¶é›†ç¼–è¯‘äº§ç‰©..." -ForegroundColor Cyan
        New-Item -ItemType Directory -Path artifacts -Force | Out-Null
        $paths = Get-ChildItem -Path "é“¶ç‹Winos" -Recurse -Directory | Where-Object {
          $_.Name -match '^(Release|x64|x86)$'
        }

        foreach ($p in $paths) {
          Write-Host "â¡ï¸ æ·»åŠ : $($p.FullName)"
          Copy-Item -Path $p.FullName -Destination artifacts -Recurse -Force
        }

    # 6ï¸âƒ£ ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: é“¶ç‹Winos-build-artifacts
        path: artifacts
