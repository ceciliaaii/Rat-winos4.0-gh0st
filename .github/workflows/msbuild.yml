name: Build é“¶ç‹Winos C++ Solutions

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: Build All Solutions in é“¶ç‹Winos
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup Visual Studio Developer Command Prompt
      uses: egor-tensin/vs-shell@v2

    - name: Build all .sln files (Chinese paths + upgrade toolset)
      shell: pwsh
      run: |
        chcp 65001 > $null

        # æ ¹ç›®å½•
        $root = (Get-Location).Path
        $artifacts = Join-Path $root "artifacts"
        $logFile = Join-Path $root "build.log"

        # æ¸…ç†æ—§ artifacts / log
        if (Test-Path $artifacts) { Remove-Item $artifacts -Recurse -Force }
        New-Item -ItemType Directory -Path $artifacts | Out-Null
        if (Test-Path $logFile) { Remove-Item $logFile }

        Write-Host "ğŸ“ å·¥ä½œç›®å½•: $root"
        Write-Host "ğŸ“¦ æ„å»ºäº§ç‰©ç›®å½•: $artifacts"
        Write-Host "ğŸ“„ æ—¥å¿—æ–‡ä»¶: $logFile"

        # æ‰«æ é“¶ç‹Winos ä¸‹æ‰€æœ‰ .sln æ–‡ä»¶
        $solutionPaths = Get-ChildItem -Path "é“¶ç‹Winos" -Recurse -Filter *.sln | ForEach-Object { $_.FullName }

        if (-not $solutionPaths) {
            Write-Host "âš ï¸ æœªæ‰¾åˆ°ä»»ä½• .sln æ–‡ä»¶ï¼" -ForegroundColor Yellow
            exit 1
        }

        foreach ($sln in $solutionPaths) {
            $slnDir = Split-Path $sln
            $slnFile = Split-Path $sln -Leaf

            Write-Host "ğŸ§± å¼€å§‹æ„å»º: $sln" -ForegroundColor Cyan
            Push-Location $slnDir

            # å‡çº§å·¥å…·é›† v100 â†’ v143
            Get-ChildItem -Recurse -Filter *.vcxproj | ForEach-Object {
                (Get-Content $_.FullName -Raw) -replace '<PlatformToolset>v100</PlatformToolset>', '<PlatformToolset>v143</PlatformToolset>' |
                Set-Content $_.FullName -Encoding UTF8
            }

            # ç”¨ç›¸å¯¹è·¯å¾„ç¼–è¯‘ï¼Œé¿å…ä¸­æ–‡è·¯å¾„é—®é¢˜
            msbuild $slnFile /p:Configuration=Release /p:Platform=x64 /m /verbosity:minimal 2>&1 | Tee-Object -FilePath $logFile -Append

            $code = $LASTEXITCODE
            Pop-Location

            if ($code -ne 0) {
                Write-Host "âŒ ç¼–è¯‘å¤±è´¥: $sln" -ForegroundColor Red
                exit 1
            } else {
                Write-Host "âœ… ç¼–è¯‘æˆåŠŸ: $sln" -ForegroundColor Green
            }
        }

        # æ”¶é›† Release äº§ç‰©
        Write-Host "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©..." -ForegroundColor Cyan
        $releaseDirs = Get-ChildItem -Path "é“¶ç‹Winos" -Recurse -Directory | Where-Object { $_.Name -match '^(Release|x64|x86)$' }

        foreach ($dir in $releaseDirs) {
            Write-Host "â¡ï¸ å¤åˆ¶ç›®å½•: $($dir.FullName)"
            Copy-Item -Path $dir.FullName -Destination $artifacts -Recurse -Force
        }

        Write-Host "âœ… å®Œæˆï¼"
        Write-Host "ğŸ“„ æ—¥å¿—æ–‡ä»¶å·²ç”Ÿæˆ: $logFile"

    - name: Upload Artifacts and Logs
      uses: actions/upload-artifact@v4
      with:
        name: Winos-build-artifacts
        path: |
          artifacts/**
          build.log
