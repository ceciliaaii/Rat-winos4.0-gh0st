name: Build winosdemo1 C++ Solutions

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: Build All Solutions in 银狐Winos
    runs-on: windows-latest

    steps:
    # 1️⃣ 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2️⃣ 设置 MSBuild 环境
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # 3️⃣ 启动 Visual Studio Developer 命令行环境
    - name: Setup Visual Studio Developer Command Prompt
      uses: egor-tensin/vs-shell@v2

    # 4️⃣ 编译所有 .sln 文件（支持中文路径 + 日志输出）
    - name: Build all .sln files (UTF-8 + logs)
      shell: pwsh
      run: |
        chcp 65001 > $null
        Write-Host "🔍 正在编译所有解决方案..." -ForegroundColor Cyan

        $ErrorActionPreference = "Continue"
        $solutions = @(
          "银狐Winos/主插件/all.sln",
          "银狐Winos/辅助插件/expand.sln"
        )

        New-Item -ItemType File -Path build.log -Force | Out-Null

        foreach ($sln in $solutions) {
          if (Test-Path $sln) {
            Write-Host "🛠️ 开始编译: $sln" -ForegroundColor Yellow
            "==============================" | Out-File -FilePath build.log -Append -Encoding utf8
            "Building $sln" | Out-File -FilePath build.log -Append -Encoding utf8

            msbuild "`"$sln`"" /p:Configuration=Release /p:Platform=x64 /m /verbosity:minimal `
              /fileLoggerParameters:LogFile="build_$((Split-Path $sln -Leaf)).log;Encoding=UTF-8"

            if ($LASTEXITCODE -ne 0) {
              Write-Host "❌ 编译失败: $sln" -ForegroundColor Red
              "Build failed: $sln" | Out-File -FilePath build.log -Append -Encoding utf8
            } else {
              Write-Host "✅ 编译成功: $sln" -ForegroundColor Green
              "Build succeeded: $sln" | Out-File -FilePath build.log -Append -Encoding utf8
            }
          } else {
            Write-Host "⚠️ 未找到文件: $sln" -ForegroundColor Red
            "File not found: $sln" | Out-File -FilePath build.log -Append -Encoding utf8
          }
        }

    # 5️⃣ 收集构建产物
    - name: Collect build artifacts
      shell: pwsh
      run: |
        chcp 65001 > $null
        Write-Host "📦 正在收集编译产物..." -ForegroundColor Cyan
        New-Item -ItemType Directory -Path artifacts -Force | Out-Null

        $paths = Get-ChildItem -Path "银狐Winos" -Recurse -Directory | Where-Object {
          $_.Name -match '^(Release|x64|x86)$'
        }

        foreach ($p in $paths) {
          Write-Host "➡️ 添加: $($p.FullName)"
          Copy-Item -Path $p.FullName -Destination artifacts -Recurse -Force
        }

    # 6️⃣ 上传产物与日志
    - name: Upload Artifacts and Logs
      uses: actions/upload-artifact@v4
      with:
        name: Winos-build-artifacts
        path: |
          artifacts
          build.log
          build_*.log
